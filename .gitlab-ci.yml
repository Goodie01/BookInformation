stages:
  - build
  - deploy

services:
  - docker:dind

build:
  stage: build
  image: maven:3.6.3-jdk-11
  script:
    - ls /root/.m2
    - mvn --batch-mode -U -f app/pom.xml clean package
  cache:
    paths:
      - /root/.m2
  artifacts:
    paths:
      - app/target/bookInformation.jar
deploy:
  stage: deploy
  image: cytopia/ansible:2.9
  only:
    - master
  script:
    - which ssh
    - export ANSIBLE_HOST_KEY_CHECKING=False
    - cp app/target/bookInformation.jar platform
    - cp "$PRODUCTION_PROPERTIES" platform
    - cd platform
    - ansible-playbook deploySite.yml -i staging/production --private-key="$SSH_KEY"